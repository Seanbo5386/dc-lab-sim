{
  "id": "domain3-mixed-gpu-gres",
  "title": "GRES Configuration for Mixed GPU Types",
  "domain": "domain3",
  "difficulty": "advanced",
  "description": "Learn how to configure Slurm GRES for clusters with multiple GPU types (e.g., A100 and H100). Proper GRES configuration enables users to request specific GPU types for their workloads.",
  "learningObjectives": [
    "Configure GRES for multiple GPU types",
    "Set up type-specific job requests",
    "Understand GPU feature constraints",
    "Configure MIG instances as GRES",
    "Troubleshoot GRES configuration issues"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Inventory GPU Types",
      "description": "Identify all GPU types in the cluster before configuration.",
      "objectives": [
        "List GPUs on each node",
        "Identify GPU models",
        "Document GPU distribution"
      ],
      "expectedCommands": [
        "nvidia-smi --query-gpu=name,uuid --format=csv",
        "sinfo -N -l"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must inventory GPU types",
          "expectedCommands": ["nvidia-smi --query-gpu=name", "sinfo"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "nvidia-smi shows GPU model names",
        "Common types: a100, h100, a30, l40",
        "Each node may have single or mixed types",
        "Document which nodes have which GPUs",
        "MIG instances are separate from physical GPUs"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "GPU Discovery",
          "url": "https://slurm.schedmd.com/gres.html"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Configure gres.conf for Multiple Types",
      "description": "Set up gres.conf to define different GPU types.",
      "objectives": [
        "Define GPU types in gres.conf",
        "Map types to devices",
        "Configure per-node settings"
      ],
      "expectedCommands": [
        "cat /etc/slurm/gres.conf",
        "scontrol show config | grep -i gres"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure gres.conf",
          "expectedCommands": ["cat /etc/slurm/gres.conf"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Format: Name=gpu Type=a100 File=/dev/nvidia[0-7]",
        "NodeName can specify per-node config",
        "AutoDetect=nvml simplifies configuration",
        "Type names are case-sensitive",
        "File paths must match actual devices"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "gres.conf",
          "url": "https://slurm.schedmd.com/gres.conf.html"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Update slurm.conf Node Definitions",
      "description": "Configure node definitions with type-specific GRES.",
      "objectives": [
        "Add GRES to node definitions",
        "Specify GPU types per node",
        "Configure features for targeting"
      ],
      "expectedCommands": [
        "scontrol show node | grep -E 'NodeName|Gres'",
        "sinfo -o '%n %G %f'"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must update node definitions",
          "expectedCommands": ["scontrol show node", "sinfo -o"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "NodeName=dgx-a100 Gres=gpu:a100:8",
        "NodeName=dgx-h100 Gres=gpu:h100:8",
        "Features can add extra targeting",
        "Features=a100,80gb,nvlink",
        "Gres count must match gres.conf"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Node Configuration",
          "url": "https://slurm.schedmd.com/slurm.conf.html"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Enable GresTypes in slurm.conf",
      "description": "Configure GresTypes parameter for GPU types.",
      "objectives": [
        "Set GresTypes parameter",
        "Understand GRES plugins",
        "Configure GPU accounting"
      ],
      "expectedCommands": [
        "scontrol show config | grep -i grestype",
        "scontrol show config | grep -i accounting"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must enable GresTypes",
          "expectedCommands": ["scontrol show config | grep -i gres"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "GresTypes=gpu enables GPU GRES",
        "AccountingStorageTRES=gres/gpu for accounting",
        "Can add gres/gpu:a100,gres/gpu:h100",
        "PriorityWeightTRES can weight GPUs",
        "Enables type-specific accounting"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "GRES Types",
          "url": "https://slurm.schedmd.com/gres.html"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Submit Type-Specific Jobs",
      "description": "Test job submission requesting specific GPU types.",
      "objectives": [
        "Request specific GPU type",
        "Verify correct allocation",
        "Test mixed-type requests"
      ],
      "expectedCommands": [
        "sbatch --gres=gpu:a100:2 --wrap=\"nvidia-smi\"",
        "sbatch --gres=gpu:h100:1 --wrap=\"nvidia-smi\"",
        "squeue -o '%i %j %P %D %b %N'"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must submit type-specific jobs",
          "expectedCommands": ["sbatch --gres=gpu:a100", "squeue"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "--gres=gpu:a100:2 requests 2 A100 GPUs",
        "--gres=gpu:h100:1 requests 1 H100 GPU",
        "Job will queue if type unavailable",
        "Check allocated GPUs in job",
        "CUDA_VISIBLE_DEVICES reflects allocation"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "GRES Job Options",
          "url": "https://slurm.schedmd.com/sbatch.html"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Configure MIG as GRES",
      "description": "Set up MIG instances as schedulable GRES resources.",
      "objectives": [
        "Understand MIG GRES options",
        "Configure MIG instances",
        "Submit MIG-targeted jobs"
      ],
      "expectedCommands": [
        "nvidia-smi mig -lgi",
        "cat /etc/slurm/gres.conf | grep -i mig"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure MIG as GRES",
          "expectedCommands": [
            "nvidia-smi mig -lgi",
            "cat /etc/slurm/gres.conf"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "MIG instances appear as separate GRES",
        "Name=gpu Type=mig-1g.5gb File=/dev/nvidia[0]",
        "Or use AutoDetect=nvml with MIG",
        "--gres=gpu:mig-1g.5gb:1 in sbatch",
        "MIG profiles have different capabilities"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "MIG with Slurm",
          "url": "https://slurm.schedmd.com/gres.html"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Set Up GRES Constraints",
      "description": "Configure constraints for complex GPU requirements.",
      "objectives": [
        "Use feature constraints",
        "Combine GRES with features",
        "Configure job constraints"
      ],
      "expectedCommands": [
        "sinfo -o '%n %G %f'",
        "sbatch --gres=gpu:1 --constraint=nvlink --wrap=\"nvidia-smi\""
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must set up constraints",
          "expectedCommands": ["sinfo -o", "sbatch --constraint"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Features add non-GRES constraints",
        "--constraint=a100|h100 for either type",
        "--constraint=nvlink for NVLink nodes",
        "Combine: --gres=gpu:2 --constraint=80gb",
        "Features defined in slurm.conf NodeName"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Job Constraints",
          "url": "https://slurm.schedmd.com/sbatch.html"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Troubleshoot GRES Issues",
      "description": "Debug common GRES configuration problems.",
      "objectives": [
        "Identify GRES misconfiguration",
        "Debug job failures",
        "Verify GRES state"
      ],
      "expectedCommands": [
        "scontrol show node | grep -i gres",
        "scontrol show job <jobid>",
        "cat /var/log/slurm/slurmd.log | grep -i gres | tail -20"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must troubleshoot GRES",
          "expectedCommands": ["scontrol show node", "scontrol show job"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "CfgTRES vs AllocTRES shows available vs used",
        "slurmd logs show GRES detection",
        "ReasonDown may indicate GRES issues",
        "Verify gres.conf matches actual GPUs",
        "Restart slurmd after config changes"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "GRES Troubleshooting",
          "url": "https://slurm.schedmd.com/gres.html"
        }
      ]
    }
  ],
  "successCriteria": [
    "Inventoried GPU types",
    "Configured gres.conf for multiple types",
    "Updated slurm.conf node definitions",
    "Enabled GresTypes",
    "Submitted type-specific jobs",
    "Configured MIG as GRES",
    "Set up GRES constraints",
    "Troubleshot GRES issues"
  ],
  "estimatedTime": 53,
  "prerequisites": ["domain3-slurm-config"],
  "tags": ["slurm", "gres", "mixed-gpu", "mig", "scheduling", "advanced"],
  "tier": 3,
  "commandFamilies": ["gpu-monitoring", "cluster-tools"],
  "explanationGateId": "gate-domain3-mixed-gpu-gres",
  "toolHints": false
}
