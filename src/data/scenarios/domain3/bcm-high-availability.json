{
  "id": "domain3-bcm-ha",
  "title": "BCM High Availability Configuration and Failover",
  "domain": "domain3",
  "difficulty": "advanced",
  "description": "Configure and validate NVIDIA Base Command Manager (BCM) High Availability setup. This scenario covers HA pair configuration, failover testing, and monitoring. BCM HA is critical for production DGX clusters to ensure continuous management plane availability.",
  "learningObjectives": [
    "Understand BCM HA architecture and components",
    "Configure BCM HA pair (primary/secondary)",
    "Test controlled failover procedures",
    "Monitor HA status and health",
    "Troubleshoot common HA issues"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Verify BCM Installation and Version",
      "description": "Before configuring HA, verify BCM is properly installed on both head nodes and check version compatibility.",
      "objectives": [
        "Check BCM version on primary node",
        "Verify cmsh connectivity",
        "Confirm required services are running"
      ],
      "expectedCommands": [
        "cmsh -c 'main; version'",
        "systemctl status cmd",
        "cmsh -c 'device; list'"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify BCM installation",
          "expectedCommands": ["cmsh", "systemctl status cmd"]
        }
      ],
      "hints": [
        "BCM version must match on both HA nodes",
        "The 'cmd' service is the main BCM daemon",
        "Use cmsh non-interactively with -c flag",
        "Common version: BCM 10.x for DGX SuperPOD",
        "Check /etc/cmd.conf for configuration location"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "BCM Administration Guide",
          "url": "https://docs.nvidia.com/base-command-manager/"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Configure HA Shared Storage",
      "description": "BCM HA requires shared storage for configuration database. Verify NFS or other shared storage is properly mounted on both nodes.",
      "objectives": [
        "Verify shared storage mount",
        "Check write permissions",
        "Validate storage accessibility from both nodes"
      ],
      "expectedCommands": [
        "df -h /cm/shared",
        "mount | grep cm",
        "ls -la /cm/shared/etc"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify shared storage",
          "expectedCommands": ["df -h", "mount"]
        }
      ],
      "hints": [
        "/cm/shared is the default BCM shared directory",
        "Shared storage must be accessible from both HA nodes",
        "NFS is commonly used for BCM shared storage",
        "Database and configuration stored in shared location",
        "Ensure proper permissions for cmd user"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "BCM Storage Requirements",
          "url": "https://docs.nvidia.com/base-command-manager/"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Configure BCM HA Pair",
      "description": "Set up the HA pair configuration between primary and secondary BCM head nodes.",
      "objectives": [
        "Enter HA configuration mode in cmsh",
        "Set primary and secondary nodes",
        "Configure virtual IP address",
        "Enable HA mode"
      ],
      "expectedCommands": [
        "cmsh -c 'ha; show'",
        "cmsh -c 'ha; set virtualip 10.0.0.100'",
        "cmsh -c 'ha; set primary bcm-head01'",
        "cmsh -c 'ha; set secondary bcm-head02'"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure HA settings",
          "expectedCommands": ["cmsh", "ha"]
        }
      ],
      "hints": [
        "Virtual IP (VIP) floats between primary and secondary",
        "Clients connect to VIP for seamless failover",
        "Both nodes must be in same subnet for VIP",
        "Use 'ha; show' to view current HA configuration",
        "Configuration is stored in shared database"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "BCM HA Configuration",
          "url": "https://docs.nvidia.com/base-command-manager/"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Verify HA Status",
      "description": "After configuration, verify HA is functioning correctly with both nodes communicating.",
      "objectives": [
        "Check HA operational status",
        "Verify heartbeat connectivity",
        "Confirm VIP assignment",
        "Check node roles (active/standby)"
      ],
      "expectedCommands": [
        "cmsh -c 'ha; status'",
        "ip addr show | grep 10.0.0.100",
        "cmsh -c 'ha; show'"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify HA status",
          "expectedCommands": ["ha; status", "ip addr"]
        }
      ],
      "hints": [
        "Status shows: ACTIVE (primary) or STANDBY (secondary)",
        "VIP should be assigned to active node only",
        "Heartbeat keeps nodes synchronized",
        "Both nodes should show 'healthy' status",
        "Check /var/log/cmd.log for HA events"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "BCM HA Monitoring",
          "url": "https://docs.nvidia.com/base-command-manager/"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Test Controlled Failover",
      "description": "Perform a controlled failover to verify HA functions correctly and services migrate to secondary.",
      "objectives": [
        "Initiate controlled failover from primary",
        "Monitor failover progress",
        "Verify VIP migration",
        "Confirm services running on new active"
      ],
      "expectedCommands": [
        "cmsh -c 'ha; failover'",
        "cmsh -c 'ha; status'",
        "ip addr show | grep 10.0.0.100"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must test failover",
          "expectedCommands": ["failover", "ha; status"]
        }
      ],
      "hints": [
        "Controlled failover is graceful - no data loss",
        "VIP migrates to new active within seconds",
        "Client connections briefly interrupted during failover",
        "Monitor /var/log/cmd.log during failover",
        "Use 'ha; failback' to return to original primary"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "BCM Failover Procedures",
          "url": "https://docs.nvidia.com/base-command-manager/"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Configure HA Monitoring and Alerts",
      "description": "Set up monitoring for HA events and configure alerts for failover situations.",
      "objectives": [
        "Enable HA event logging",
        "Configure email alerts for failover",
        "Set up health monitoring thresholds",
        "Test alert functionality"
      ],
      "expectedCommands": [
        "cmsh -c 'monitoring; show alerts'",
        "cmsh -c 'main; set emailaddress admin@example.com'",
        "cmsh -c 'ha; set notification enabled'"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure HA monitoring",
          "expectedCommands": ["monitoring", "notification"]
        }
      ],
      "hints": [
        "Alerts notify admins of automatic failovers",
        "Configure SMTP server for email delivery",
        "Monitor events: failover, failback, heartbeat loss",
        "Consider integrating with external monitoring (Prometheus/Grafana)",
        "Check 'cmsh monitoring; events' for recent events"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "BCM Monitoring",
          "url": "https://docs.nvidia.com/base-command-manager/"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Document HA Configuration",
      "description": "Create documentation of the HA setup for operational runbooks and disaster recovery procedures.",
      "objectives": [
        "Export HA configuration",
        "Document VIP and network settings",
        "Create failover procedure runbook",
        "Backup configuration database"
      ],
      "expectedCommands": [
        "cmsh -c 'ha; export /tmp/ha-config.txt'",
        "cmsh -c 'main; config backup /cm/shared/backup/'",
        "cmsh -c 'device; export'"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must document configuration",
          "expectedCommands": ["export", "backup"]
        }
      ],
      "hints": [
        "Regular backups are essential for HA",
        "Document: VIP, node names, shared storage paths",
        "Include recovery procedures in runbook",
        "Test restore procedures periodically",
        "Store backups in multiple locations"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "BCM Backup and Recovery",
          "url": "https://docs.nvidia.com/base-command-manager/"
        }
      ]
    }
  ],
  "successCriteria": [
    "Verified BCM installation and version",
    "Configured shared storage for HA",
    "Set up BCM HA pair with VIP",
    "Verified HA status and health",
    "Successfully tested controlled failover",
    "Configured monitoring and alerts",
    "Documented HA configuration"
  ],
  "estimatedTime": 45,
  "prerequisites": ["domain3-slurm"],
  "tags": [
    "bcm",
    "high-availability",
    "failover",
    "cluster-management",
    "advanced",
    "exam-critical",
    "domain3"
  ],
  "tier": 3,
  "commandFamilies": ["cluster-tools"],
  "explanationGateId": "gate-domain3-bcm-ha",
  "toolHints": false
}
