{
  "id": "domain3-nfs-tuning",
  "title": "NFS Performance Tuning for GPU Workloads",
  "domain": "domain3",
  "difficulty": "intermediate",
  "description": "Learn how to tune NFS client configuration for optimal performance with GPU training workloads. Proper NFS tuning can significantly improve data loading performance.",
  "learningObjectives": [
    "Configure NFS mount options",
    "Optimize read-ahead and caching",
    "Tune NFS for training workloads",
    "Monitor NFS performance",
    "Troubleshoot NFS issues"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Review Current NFS Configuration",
      "description": "Check existing NFS mounts and their configuration.",
      "objectives": [
        "List current NFS mounts",
        "Check mount options",
        "Identify NFS version"
      ],
      "expectedCommands": [
        "mount | grep nfs",
        "nfsstat -m",
        "cat /etc/fstab | grep nfs"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must review NFS configuration",
          "expectedCommands": ["mount | grep nfs", "nfsstat -m"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "nfsstat -m shows mount options",
        "Check vers= for NFS version",
        "NFSv4 recommended for most cases",
        "Look for rsize/wsize settings",
        "Check soft vs hard mount"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "NFS Mount Options",
          "url": "https://linux.die.net/man/5/nfs"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Configure Optimal Mount Options",
      "description": "Set up NFS mount with performance-optimized options.",
      "objectives": [
        "Set rsize and wsize",
        "Configure async/sync mode",
        "Enable appropriate caching"
      ],
      "expectedCommands": [
        "mount -o rsize=1048576,wsize=1048576,nconnect=8,vers=4.1 server:/export /mnt/nfs",
        "nfsstat -m"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure mount options",
          "expectedCommands": ["mount -o rsize", "nfsstat -m"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "rsize/wsize=1048576 (1MB) for large I/O",
        "nconnect=8 enables multiple TCP connections",
        "async improves write performance",
        "noatime reduces metadata updates",
        "hard mount recommended for reliability"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "NFS Performance",
          "url": "https://wiki.archlinux.org/title/NFS"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Tune Read-Ahead Settings",
      "description": "Configure read-ahead for streaming data access patterns.",
      "objectives": [
        "Check current read-ahead",
        "Optimize for sequential reads",
        "Balance with memory usage"
      ],
      "expectedCommands": [
        "cat /sys/class/bdi/*/read_ahead_kb",
        "blockdev --getra /dev/nfs",
        "echo 16384 > /sys/class/bdi/0:*/read_ahead_kb"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must tune read-ahead",
          "expectedCommands": ["cat /sys/class/bdi/*/read_ahead_kb"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Default read-ahead may be too small",
        "16MB+ for large sequential reads",
        "Match data loading patterns",
        "Higher values use more memory",
        "Per-mount tuning possible"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Linux Read-Ahead",
          "url": "https://www.kernel.org/doc/Documentation/block/queue-sysfs.txt"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Configure Sunrpc Settings",
      "description": "Tune sunrpc parameters for better NFS performance.",
      "objectives": [
        "Check sunrpc settings",
        "Adjust slot table size",
        "Configure tcp slot count"
      ],
      "expectedCommands": [
        "cat /proc/sys/sunrpc/tcp_slot_table_entries",
        "echo 128 > /proc/sys/sunrpc/tcp_slot_table_entries",
        "sysctl sunrpc.tcp_max_slot_table_entries"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure sunrpc",
          "expectedCommands": ["cat /proc/sys/sunrpc/tcp_slot_table_entries"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Default slot table often too small",
        "128 slots recommended for high I/O",
        "Affects concurrent RPC requests",
        "Higher values for many clients",
        "Set before mounting NFS"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "SUNRPC Tuning",
          "url": "https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Test NFS Performance",
      "description": "Benchmark NFS performance with different configurations.",
      "objectives": [
        "Test read performance",
        "Test write performance",
        "Compare with baseline"
      ],
      "expectedCommands": [
        "dd if=/mnt/nfs/testfile of=/dev/null bs=1M count=1024",
        "dd if=/dev/zero of=/mnt/nfs/testfile bs=1M count=1024",
        "fio --name=randread --directory=/mnt/nfs --size=1G --rw=randread"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must test NFS performance",
          "expectedCommands": ["dd if=/mnt/nfs", "dd if=/dev/zero of=/mnt/nfs"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Use dd for sequential throughput",
        "Use fio for realistic patterns",
        "Test both reads and writes",
        "Expected: 100MB/s to 10GB/s",
        "Network bandwidth is often limit"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "NFS Benchmarking",
          "url": "https://linux.die.net/man/1/fio"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Monitor NFS Statistics",
      "description": "Monitor NFS client performance metrics.",
      "objectives": [
        "View NFS statistics",
        "Check retransmissions",
        "Monitor RPC performance"
      ],
      "expectedCommands": [
        "nfsstat -c",
        "nfsiostat 1 5",
        "cat /proc/self/mountstats | head -50"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must monitor NFS statistics",
          "expectedCommands": ["nfsstat -c", "nfsiostat"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "nfsstat shows RPC statistics",
        "nfsiostat shows I/O rates",
        "Look for retransmissions (network issues)",
        "High timeouts indicate congestion",
        "mountstats gives detailed metrics"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "NFS Monitoring",
          "url": "https://linux.die.net/man/8/nfsstat"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Optimize for Training Data Loading",
      "description": "Configure NFS specifically for AI training data patterns.",
      "objectives": [
        "Understand training I/O patterns",
        "Configure for DataLoader access",
        "Handle many small files"
      ],
      "expectedCommands": [
        "mount -o rsize=1048576,wsize=1048576,noatime,nodiratime,nconnect=8 server:/datasets /mnt/datasets",
        "nfsstat -m"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must optimize for training",
          "expectedCommands": ["mount -o rsize", "nfsstat -m"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Training reads are often sequential",
        "DataLoader may read many small files",
        "noatime reduces metadata overhead",
        "nconnect helps parallel reads",
        "Consider local caching for hot data"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "NFS for AI",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Troubleshoot NFS Issues",
      "description": "Debug common NFS performance problems.",
      "objectives": [
        "Identify slow operations",
        "Debug mount issues",
        "Resolve network problems"
      ],
      "expectedCommands": [
        "rpcdebug -m nfs -s all",
        "dmesg | grep -i nfs | tail -20",
        "tcpdump -i eth0 port 2049 -c 100"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must troubleshoot NFS",
          "expectedCommands": ["rpcdebug -m nfs", "dmesg | grep -i nfs"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "rpcdebug enables NFS tracing",
        "dmesg shows kernel NFS messages",
        "Check network with tcpdump",
        "High retrans count = network issue",
        "Stale file handles = server restart"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "NFS Troubleshooting",
          "url": "https://linux.die.net/man/8/rpcdebug"
        }
      ]
    }
  ],
  "successCriteria": [
    "Reviewed current NFS configuration",
    "Configured optimal mount options",
    "Tuned read-ahead settings",
    "Configured sunrpc settings",
    "Tested NFS performance",
    "Monitored NFS statistics",
    "Optimized for training workloads",
    "Troubleshot NFS issues"
  ],
  "estimatedTime": 48,
  "prerequisites": ["domain3-storage-validation"],
  "tags": ["nfs", "storage", "performance", "tuning", "intermediate"],
  "tier": 2,
  "commandFamilies": ["cluster-tools"],
  "explanationGateId": "gate-domain3-nfs-tuning"
}
