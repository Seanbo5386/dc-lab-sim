{
  "id": "domain3-pyxis-advanced",
  "title": "Advanced Pyxis and Enroot Integration",
  "domain": "domain3",
  "difficulty": "advanced",
  "description": "Master advanced Pyxis and Enroot features including container caching, multi-node MPI jobs, custom container builds, and performance optimization for HPC workloads.",
  "learningObjectives": [
    "Configure Enroot container caching",
    "Run multi-node MPI containers",
    "Build custom Enroot containers",
    "Optimize container performance",
    "Troubleshoot container issues"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Configure Enroot Storage",
      "description": "Set up optimal Enroot storage locations and caching.",
      "objectives": [
        "Configure runtime path",
        "Set up data path for caching",
        "Optimize storage layout"
      ],
      "expectedCommands": [
        "cat /etc/enroot/enroot.conf",
        "enroot list",
        "ls $ENROOT_RUNTIME_PATH"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure Enroot storage",
          "expectedCommands": ["cat /etc/enroot/enroot.conf", "enroot list"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "ENROOT_RUNTIME_PATH for container runtime",
        "ENROOT_DATA_PATH for squashfs images",
        "Use local SSD for runtime (performance)",
        "Use shared storage for images (accessibility)",
        "Configure in /etc/enroot/enroot.conf"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Enroot Configuration",
          "url": "https://github.com/NVIDIA/enroot"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Configure Pyxis Plugin",
      "description": "Set up Pyxis Slurm plugin for container support.",
      "objectives": [
        "Verify Pyxis installation",
        "Configure Pyxis options",
        "Set container defaults"
      ],
      "expectedCommands": [
        "srun --help | grep container",
        "cat /etc/slurm/plugstack.conf | grep pyxis"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure Pyxis",
          "expectedCommands": [
            "srun --help | grep container",
            "cat /etc/slurm/plugstack.conf"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Pyxis adds --container-* options to srun/sbatch",
        "Configure in plugstack.conf",
        "default_image can set default container",
        "runtime_flags for container options",
        "Requires Enroot backend"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Pyxis Configuration",
          "url": "https://github.com/NVIDIA/pyxis"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Use Container Caching",
      "description": "Leverage container caching for faster job startup.",
      "objectives": [
        "Understand caching mechanism",
        "Pre-pull containers",
        "Verify cache hits"
      ],
      "expectedCommands": [
        "enroot import --output /shared/containers/pytorch.sqsh docker://nvcr.io/nvidia/pytorch:24.01-py3",
        "srun --container-image=/shared/containers/pytorch.sqsh nvidia-smi"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must use container caching",
          "expectedCommands": [
            "enroot import --output",
            "srun --container-image"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Pre-import to shared storage",
        "Use .sqsh file path directly",
        "Avoids pull on each job start",
        "Significantly faster startup",
        "Keep cache updated with releases"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Container Caching",
          "url": "https://github.com/NVIDIA/enroot"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Run Multi-Node MPI Jobs",
      "description": "Execute MPI jobs across multiple nodes using containers.",
      "objectives": [
        "Configure MPI in containers",
        "Launch multi-node jobs",
        "Handle network configuration"
      ],
      "expectedCommands": [
        "srun -N 2 --ntasks-per-node=8 --gres=gpu:8 --container-image=nvcr.io/nvidia/pytorch:24.01-py3 python -m torch.distributed.run train.py",
        "sbatch --nodes=2 --ntasks-per-node=8 --gres=gpu:8 --container-image=nvcr.io/nvidia/pytorch:24.01-py3 mpi_job.sh"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must run multi-node MPI jobs",
          "expectedCommands": ["srun -N 2 --container-image"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "PMI/PMIx for process management",
        "--container-mounts for shared storage",
        "InfiniBand passthrough with --container-env",
        "NCCL_IB_DISABLE=0 for IB networking",
        "Use torch.distributed.run for PyTorch"
      ],
      "estimatedDuration": 10,
      "documentationLinks": [
        {
          "title": "Multi-Node Training",
          "url": "https://docs.nvidia.com/deeplearning/frameworks/user-guide/"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Configure Container Mounts",
      "description": "Set up advanced mount configurations for containers.",
      "objectives": [
        "Mount datasets and models",
        "Configure overlay filesystems",
        "Handle permissions"
      ],
      "expectedCommands": [
        "srun --container-image=nvcr.io/nvidia/pytorch:24.01-py3 --container-mounts=/data:/data,/models:/models:ro ls /data",
        "srun --container-image=nvcr.io/nvidia/pytorch:24.01-py3 --container-workdir=/workspace pwd"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure container mounts",
          "expectedCommands": [
            "srun --container-image --container-mounts",
            "srun --container-image --container-workdir"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "--container-mounts=src:dst:options",
        "Options: ro (read-only), rw (default)",
        "--container-workdir sets working directory",
        "Lustre/GPFS mount through container",
        "Use bind mounts for performance"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Pyxis Mounts",
          "url": "https://github.com/NVIDIA/pyxis"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Pass Environment Variables",
      "description": "Configure environment variables for containerized jobs.",
      "objectives": [
        "Pass host environment",
        "Set container-specific variables",
        "Configure NCCL and CUDA"
      ],
      "expectedCommands": [
        "srun --container-image=nvcr.io/nvidia/pytorch:24.01-py3 --container-env=NCCL_DEBUG=INFO env | grep NCCL",
        "export NCCL_DEBUG=INFO && srun --container-image=nvcr.io/nvidia/pytorch:24.01-py3 env | grep NCCL"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must pass environment variables",
          "expectedCommands": ["srun --container-image --container-env"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "--container-env passes specific vars",
        "Host vars passed by default (configurable)",
        "NCCL_* for networking configuration",
        "CUDA_VISIBLE_DEVICES set by GRES",
        "--export=ALL,NCCL_DEBUG=INFO also works"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Environment Variables",
          "url": "https://github.com/NVIDIA/pyxis"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Build Custom Containers",
      "description": "Create custom containers based on NGC images.",
      "objectives": [
        "Extend NGC base image",
        "Add custom packages",
        "Export for cluster use"
      ],
      "expectedCommands": [
        "enroot create --name custom-pytorch nvcr.io+nvidia+pytorch+24.01-py3.sqsh",
        "enroot start --rw custom-pytorch pip install custom-package",
        "enroot export --output custom-pytorch.sqsh custom-pytorch"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must build custom containers",
          "expectedCommands": [
            "enroot create --name",
            "enroot start --rw",
            "enroot export --output"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "enroot create makes writable container",
        "enroot start --rw for modifications",
        "Install additional packages",
        "enroot export creates new squashfs",
        "Or use Dockerfile and convert"
      ],
      "estimatedDuration": 10,
      "documentationLinks": [
        {
          "title": "Custom Containers",
          "url": "https://github.com/NVIDIA/enroot"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Troubleshoot Container Issues",
      "description": "Debug common container and Pyxis problems.",
      "objectives": [
        "Debug container startup",
        "Check GPU visibility",
        "Resolve networking issues"
      ],
      "expectedCommands": [
        "srun --container-image=nvcr.io/nvidia/pytorch:24.01-py3 env | head -30",
        "srun --container-image=nvcr.io/nvidia/pytorch:24.01-py3 ls /dev/nvidia*",
        "srun --container-image=nvcr.io/nvidia/pytorch:24.01-py3 ibstat"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must troubleshoot container issues",
          "expectedCommands": [
            "srun --container-image env",
            "srun --container-image ls /dev/nvidia"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Check CUDA_VISIBLE_DEVICES in container",
        "Verify /dev/nvidia* devices present",
        "ibstat for InfiniBand visibility",
        "ENROOT_RUNTIME_PATH permissions",
        "Check Slurm logs for Pyxis errors"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "Troubleshooting",
          "url": "https://github.com/NVIDIA/pyxis"
        }
      ]
    }
  ],
  "successCriteria": [
    "Configured Enroot storage",
    "Configured Pyxis plugin",
    "Used container caching",
    "Ran multi-node MPI jobs",
    "Configured container mounts",
    "Passed environment variables",
    "Built custom containers",
    "Troubleshot container issues"
  ],
  "estimatedTime": 59,
  "prerequisites": ["domain3-container-runtime", "domain3-ngc-pipeline"],
  "tags": ["pyxis", "enroot", "containers", "mpi", "multi-node", "advanced"],
  "tier": 3,
  "commandFamilies": ["container-tools", "cluster-tools"],
  "explanationGateId": "gate-domain3-pyxis-advanced",
  "toolHints": false
}
