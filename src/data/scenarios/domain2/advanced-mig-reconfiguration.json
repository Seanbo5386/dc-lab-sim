{
  "id": "domain2-advanced-mig",
  "title": "Advanced MIG Dynamic Reconfiguration",
  "domain": "domain2",
  "difficulty": "advanced",
  "description": "Learn advanced Multi-Instance GPU (MIG) configuration techniques including dynamic reconfiguration, workload migration, and resource optimization strategies for production environments.",
  "learningObjectives": [
    "Perform dynamic MIG profile changes",
    "Understand MIG resource allocation",
    "Plan workload migration during MIG changes",
    "Optimize MIG configurations for different workloads",
    "Troubleshoot MIG configuration issues"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Review Current MIG Configuration",
      "description": "Assess the current MIG configuration and understand the existing resource allocation.",
      "objectives": [
        "Check MIG mode status on all GPUs",
        "List existing GPU instances",
        "Review compute instance allocation"
      ],
      "expectedCommands": [
        "nvidia-smi -i 0 --query-gpu=mig.mode.current --format=csv",
        "nvidia-smi mig -lgi",
        "nvidia-smi mig -lci"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must review MIG configuration",
          "expectedCommands": ["nvidia-smi mig -lgi", "nvidia-smi mig -lci"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Use 'nvidia-smi mig -lgi' to list GPU instances",
        "Use 'nvidia-smi mig -lci' to list compute instances",
        "Check MIG mode: nvidia-smi --query-gpu=mig.mode.current --format=csv",
        "MIG profiles determine memory and compute slices",
        "A100 supports MIG, older GPUs do not"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "MIG User Guide",
          "url": "https://docs.nvidia.com/datacenter/tesla/mig-user-guide/"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Understand MIG Profile Options",
      "description": "Learn about available MIG profiles and their resource allocation characteristics.",
      "objectives": [
        "List available GPU instance profiles",
        "Understand profile naming convention",
        "Compare profile resource allocation"
      ],
      "expectedCommands": ["nvidia-smi mig -lgip", "nvidia-smi mig -lgipp"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must understand MIG profiles",
          "expectedCommands": ["nvidia-smi mig -lgip"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Profile naming: <slices>g.<memory>gb (e.g., 3g.40gb)",
        "A100 80GB supports profiles: 1g.10gb through 7g.80gb",
        "More slices = more compute, more memory",
        "Not all profile combinations are valid",
        "Use -lgipp for placement info"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "MIG Profiles",
          "url": "https://docs.nvidia.com/datacenter/tesla/mig-user-guide/"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Plan MIG Reconfiguration",
      "description": "Plan a MIG reconfiguration to meet new workload requirements.",
      "objectives": [
        "Identify target configuration",
        "Determine resource requirements",
        "Plan migration steps"
      ],
      "expectedCommands": ["nvidia-smi mig -lgip", "nvidia-smi"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must plan reconfiguration",
          "expectedCommands": ["nvidia-smi mig -lgip", "nvidia-smi"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Consider workload memory requirements",
        "Consider compute requirements (SM count)",
        "Balance between isolation and utilization",
        "Example: 4x 1g.10gb for inference, 1x 4g.40gb for training",
        "Reconfiguration requires destroying existing instances"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "MIG Planning",
          "url": "https://docs.nvidia.com/datacenter/tesla/mig-user-guide/"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Verify No Active Workloads",
      "description": "Ensure no processes are using the GPU instances before reconfiguration.",
      "objectives": [
        "Check for running processes",
        "Identify MIG instance usage",
        "Prepare for safe reconfiguration"
      ],
      "expectedCommands": [
        "nvidia-smi",
        "nvidia-smi mig -lgi",
        "fuser -v /dev/nvidia*"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify no active workloads",
          "expectedCommands": ["nvidia-smi", "fuser -v /dev/nvidia"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Check 'Processes' section in nvidia-smi",
        "MIG instances in use cannot be destroyed",
        "Container workloads must be stopped",
        "DCGM may hold references to instances",
        "Slurm jobs using MIG must complete first"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "MIG Instance Management",
          "url": "https://docs.nvidia.com/datacenter/tesla/mig-user-guide/"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Destroy Existing MIG Instances",
      "description": "Remove existing compute and GPU instances to prepare for new configuration.",
      "objectives": [
        "Destroy compute instances first",
        "Then destroy GPU instances",
        "Verify clean state"
      ],
      "expectedCommands": [
        "nvidia-smi mig -dci -gi 0",
        "nvidia-smi mig -dgi -gi 0",
        "nvidia-smi mig -lgi"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must destroy existing instances",
          "expectedCommands": ["nvidia-smi mig -dci", "nvidia-smi mig -dgi"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Order matters: CIs must be destroyed before GIs",
        "Use -gi to specify GPU instance ID",
        "Use -ci to specify compute instance ID",
        "-dci destroys all CIs in a GI by default",
        "Verify with 'nvidia-smi mig -lgi' showing no instances"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "MIG Instance Destruction",
          "url": "https://docs.nvidia.com/datacenter/tesla/mig-user-guide/"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Create New MIG Configuration",
      "description": "Create new GPU and compute instances according to the planned configuration.",
      "objectives": [
        "Create GPU instances with desired profiles",
        "Create compute instances",
        "Verify new configuration"
      ],
      "expectedCommands": [
        "nvidia-smi mig -cgi 19,19,19,19 -i 0",
        "nvidia-smi mig -cci -gi 0,1,2,3",
        "nvidia-smi mig -lgi"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must create new MIG instances",
          "expectedCommands": ["nvidia-smi mig -cgi", "nvidia-smi mig -cci"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "-cgi creates GPU instances (profile IDs from -lgip)",
        "-cci creates compute instances",
        "Profile 19 = 1g.10gb on A100 80GB",
        "Use -C flag to auto-create compute instances",
        "Multiple profiles can be comma-separated"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "MIG Instance Creation",
          "url": "https://docs.nvidia.com/datacenter/tesla/mig-user-guide/"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Verify MIG Configuration",
      "description": "Confirm the new MIG configuration is correct and all instances are healthy.",
      "objectives": [
        "List all GPU instances",
        "Verify compute instances",
        "Check instance health"
      ],
      "expectedCommands": [
        "nvidia-smi mig -lgi",
        "nvidia-smi mig -lci",
        "nvidia-smi"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify MIG configuration",
          "expectedCommands": [
            "nvidia-smi mig -lgi",
            "nvidia-smi mig -lci",
            "nvidia-smi"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "All instances should show in 'nvidia-smi'",
        "Each GI should have at least one CI",
        "Check UUID for each MIG device",
        "MIG devices visible as GPU 0/1, 0/2, etc.",
        "CUDA_VISIBLE_DEVICES can target specific instances"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "MIG Verification",
          "url": "https://docs.nvidia.com/datacenter/tesla/mig-user-guide/"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Test MIG Instance Functionality",
      "description": "Validate that the new MIG instances are working correctly.",
      "objectives": [
        "Run test workload on MIG instance",
        "Verify resource isolation",
        "Confirm expected performance"
      ],
      "expectedCommands": [
        "nvidia-smi",
        "nvidia-smi mig -lgi",
        "dcgmi discovery -l"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must test MIG functionality",
          "expectedCommands": ["nvidia-smi", "dcgmi discovery -l"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Use CUDA_VISIBLE_DEVICES=MIG-<uuid> to target instance",
        "Each instance has isolated memory",
        "DCGM should discover all MIG instances",
        "Run simple CUDA test to verify",
        "Containers can target specific MIG devices"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "MIG with Containers",
          "url": "https://docs.nvidia.com/datacenter/tesla/mig-user-guide/"
        }
      ]
    }
  ],
  "successCriteria": [
    "Reviewed current MIG configuration",
    "Understood available MIG profiles",
    "Planned new MIG configuration",
    "Verified no active workloads",
    "Destroyed existing instances",
    "Created new MIG instances",
    "Verified new configuration",
    "Tested MIG instance functionality"
  ],
  "estimatedTime": 47,
  "prerequisites": ["domain2-mig-config"],
  "tags": [
    "mig",
    "reconfiguration",
    "gpu-partitioning",
    "resource-management",
    "advanced"
  ],
  "tier": 3,
  "commandFamilies": ["gpu-monitoring", "diagnostics"],
  "explanationGateId": "gate-domain2-advanced-mig",
  "toolHints": false
}
