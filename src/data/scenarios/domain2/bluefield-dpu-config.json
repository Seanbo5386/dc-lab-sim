{
  "id": "domain2-bluefield-dpu",
  "title": "BlueField DPU Configuration and Mode Switching",
  "domain": "domain2",
  "difficulty": "advanced",
  "description": "Learn how to configure NVIDIA BlueField Data Processing Units (DPUs) including mode switching, network configuration, and integration with DGX systems.",
  "learningObjectives": [
    "Understand BlueField DPU architecture",
    "Query DPU status and configuration",
    "Switch between DPU operational modes",
    "Configure DPU networking",
    "Integrate DPU with host system"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Understand BlueField Architecture",
      "description": "Learn the BlueField DPU architecture and its role in DGX systems.",
      "objectives": [
        "Understand DPU components",
        "Learn about Arm cores and ConnectX",
        "Know operational modes"
      ],
      "expectedCommands": ["lspci | grep -i mellanox", "mst status"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must understand BlueField architecture",
          "expectedCommands": ["lspci | grep -i mellanox", "mst status"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "BlueField combines ConnectX NIC + Arm SoC",
        "DPU runs its own OS on Arm cores",
        "Can offload networking, security, storage",
        "Modes: DPU, NIC, Separated Host",
        "DGX systems may include BlueField for networking"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "BlueField Overview",
          "url": "https://docs.nvidia.com/networking/display/bluefield"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Initialize MST Tools",
      "description": "Start Mellanox Software Tools to interact with BlueField devices.",
      "objectives": [
        "Start MST service",
        "List MST devices",
        "Identify BlueField devices"
      ],
      "expectedCommands": ["mst start", "mst status", "mst status -v"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must initialize MST",
          "expectedCommands": ["mst start", "mst status"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "MST provides low-level device access",
        "Device names: /dev/mst/mt41686_pciconf0",
        "BlueField-2: mt41686, BlueField-3: mt41692",
        "Use -v for verbose output",
        "MST required for configuration changes"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "MST Tools",
          "url": "https://docs.nvidia.com/networking/display/mlofedforum"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Query Current DPU Mode",
      "description": "Check the current operational mode of the BlueField DPU.",
      "objectives": [
        "Query DPU mode settings",
        "Understand mode parameters",
        "Check current configuration"
      ],
      "expectedCommands": [
        "mlxconfig -d /dev/mst/mt41686_pciconf0 q | grep -i internal",
        "mlxconfig -d /dev/mst/mt41686_pciconf0 q"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must query DPU mode",
          "expectedCommands": ["mlxconfig -d /dev/mst/mt41686_pciconf0 q"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "INTERNAL_CPU_MODEL controls DPU mode",
        "INTERNAL_CPU_PAGE_SUPPLIER affects memory",
        "Mode 0: DPU mode (default)",
        "Mode 1: NIC mode (Arm disabled)",
        "Check current vs next-boot settings"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "BlueField Modes",
          "url": "https://docs.nvidia.com/networking/display/bluefield"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Understand DPU Modes",
      "description": "Learn about the different BlueField operational modes.",
      "objectives": [
        "Understand DPU mode",
        "Understand NIC mode",
        "Understand Separated Host mode"
      ],
      "expectedCommands": [
        "mlxconfig -d /dev/mst/mt41686_pciconf0 q | grep -i model",
        "ibstat"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must understand DPU modes",
          "expectedCommands": [
            "mlxconfig -d /dev/mst/mt41686_pciconf0 q",
            "ibstat"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "DPU Mode: Full offload, Arm owns network",
        "NIC Mode: Traditional NIC, Arm disabled",
        "Separated Host: Both host and Arm active",
        "Embedded CPU Mode affects networking model",
        "Mode selection depends on use case"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Operating Modes",
          "url": "https://docs.nvidia.com/networking/display/bluefield"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Check DPU Network Configuration",
      "description": "Review the DPU network interface configuration.",
      "objectives": [
        "List network interfaces",
        "Check interface status",
        "Understand interface mapping"
      ],
      "expectedCommands": [
        "ibstat",
        "ip link show",
        "mlxlink -d /dev/mst/mt41686_pciconf0 -m"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check network configuration",
          "expectedCommands": ["ibstat", "ip link show"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "DPU exposes representor interfaces",
        "pf0hpf/pf1hpf are host-facing ports",
        "p0/p1 are external ports",
        "OVS bridges representors for switching",
        "Check link status with mlxlink"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "BlueField Networking",
          "url": "https://docs.nvidia.com/networking/display/bluefield"
        }
      ]
    },
    {
      "id": "step6",
      "title": "View DPU Firmware Information",
      "description": "Check BlueField firmware version and update status.",
      "objectives": [
        "Query firmware version",
        "Check firmware status",
        "Understand update requirements"
      ],
      "expectedCommands": [
        "mlxfwmanager --query",
        "flint -d /dev/mst/mt41686_pciconf0 q"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must view firmware information",
          "expectedCommands": ["mlxfwmanager --query"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Firmware version critical for features",
        "BFB (BlueField Bundle) updates Arm OS",
        "ConnectX firmware is separate",
        "Check NVIDIA release notes for compatibility",
        "Firmware update requires reboot"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Firmware Management",
          "url": "https://docs.nvidia.com/networking/display/bluefield"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Understand Mode Switching Process",
      "description": "Learn how to prepare for and execute DPU mode changes.",
      "objectives": [
        "Know mode switch prerequisites",
        "Understand configuration commands",
        "Know reboot requirements"
      ],
      "expectedCommands": [
        "mlxconfig -d /dev/mst/mt41686_pciconf0 q",
        "mst status"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must understand mode switching",
          "expectedCommands": [
            "mlxconfig -d /dev/mst/mt41686_pciconf0 q",
            "mst status"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Mode change: mlxconfig -d <dev> set INTERNAL_CPU_MODEL=<mode>",
        "Requires cold reboot (power cycle)",
        "Warm reboot not sufficient",
        "BMC power cycle recommended",
        "Backup current configuration first"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Mode Switching",
          "url": "https://docs.nvidia.com/networking/display/bluefield"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Verify DPU Health",
      "description": "Check overall DPU health and operational status.",
      "objectives": [
        "Check DPU connectivity",
        "Verify Arm cores status",
        "Check network connectivity"
      ],
      "expectedCommands": [
        "ibstat",
        "mlxlink -d /dev/mst/mt41686_pciconf0",
        "mst status -v"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify DPU health",
          "expectedCommands": [
            "ibstat",
            "mlxlink -d /dev/mst/mt41686_pciconf0"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "IB ports should show 'Active' state",
        "mlxlink shows link health and errors",
        "SSH to DPU Arm: ssh ubuntu@192.168.100.2",
        "DPU has OOB management interface",
        "Check Arm OS with: bfb-info"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "DPU Health Monitoring",
          "url": "https://docs.nvidia.com/networking/display/bluefield"
        }
      ]
    }
  ],
  "successCriteria": [
    "Understood BlueField DPU architecture",
    "Initialized MST tools",
    "Queried current DPU mode",
    "Understood different DPU modes",
    "Checked network configuration",
    "Viewed firmware information",
    "Understood mode switching process",
    "Verified DPU health"
  ],
  "estimatedTime": 48,
  "prerequisites": ["domain1-driver-install"],
  "tags": ["bluefield", "dpu", "networking", "offload", "advanced"],
  "tier": 3,
  "commandFamilies": ["infiniband-tools"],
  "explanationGateId": "gate-domain2-bluefield-dpu",
  "toolHints": false
}
